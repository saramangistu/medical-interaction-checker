<%- include('../partials/header', { title: "Doctor Registration", user: user }) %>

<main class="container">
  <div class="form-card">
    <h1>Doctor Registration</h1>

    <% if (typeof error !== 'undefined' && error) { %>
      <div class="alert alert-danger"><%= error %></div>
    <% } %>
    <% if (typeof success !== 'undefined' && success) { %>
      <div class="alert alert-success"><%= success %></div>
    <% } %>

    <!-- ✅ נתיב תואם ל-authRoutes -->
    <form action="/auth/register-doctor" method="POST" enctype="multipart/form-data">
      <!-- Username -->
      <div class="form-group">
        <label for="username">Username:</label>
        <input type="text" id="username" name="username" required>
      </div>

      <!-- Password -->
      <div class="form-group">
        <label for="password">Password:</label>
        <input type="password" id="password" name="password" required>
      </div>

      <!-- First name -->
      <div class="form-group">
        <label for="firstName">First Name:</label>
        <input type="text" id="firstName" name="firstName" required>
      </div>

      <!-- Last name -->
      <div class="form-group">
        <label for="lastName">Last Name:</label>
        <input type="text" id="lastName" name="lastName" required>
      </div>

      <!-- Specialization -->
      <div class="form-group">
        <label for="specialization">Specialization:</label>
        <input type="text" id="specialization" name="specialization" required>
      </div>

      <!-- License number -->
      <div class="form-group">
        <label for="licenseNumber">License Number:</label>
        <input type="text" id="licenseNumber" name="licenseNumber" required>
      </div>

      <!-- Years of experience -->
      <div class="form-group">
        <label for="yearsOfExperience">Years of Experience:</label>
        <input type="number" id="yearsOfExperience" name="yearsOfExperience" required min="0">
      </div>

      <!-- Email -->
      <div class="form-group">
        <label for="email">Email:</label>
        <input type="email" id="email" name="email" required>
      </div>

      <!-- Phone -->
      <div class="form-group">
        <label for="phone">Phone:</label>
        <input type="text" id="phone" name="phone">
      </div>

      <!-- Profile Image -->
      <div class="form-group">
        <label for="profileImage">Profile Image:</label>
        <input type="file" id="profileImage" name="profileImage" accept="image/*" required>
        <div id="imageError" class="error-message hidden"></div>
      </div>

      <!-- Preview -->
      <div class="form-group hidden" id="previewContainer">
        <label>Preview:</label>
        <img id="imagePreview" src="" alt="Profile Preview" class="profile-preview">
      </div>

      <button type="submit" class="btn-primary">Register</button>
    </form>

    <div class="form-footer">
      <p>Already have an account? <a href="/auth/login" class="link">Login here</a></p>
    </div>
  </div>
</main>

<%- include('../partials/footer') %>

<script>
  const profileInput = document.getElementById('profileImage');
  const errorBox = document.getElementById('imageError');
  const previewContainer = document.getElementById('previewContainer');
  const preview = document.getElementById('imagePreview');

  profileInput.addEventListener('change', async function(event) {
    const file = event.target.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('profileImage', file);

    try {
      const res = await fetch('/auth/validate-image', {
        method: 'POST',
        body: formData
      });
      const data = await res.json();

      if (data.success) {
        errorBox.classList.add('hidden');
        preview.src = data.fileUrl || URL.createObjectURL(file);
        previewContainer.classList.remove('hidden');
      } else {
        errorBox.textContent = data.message || "❌ Invalid image. Please upload a clear photo of a person.";
        errorBox.classList.remove('hidden');
        previewContainer.classList.add('hidden');
        profileInput.value = "";
      }
    } catch (err) {
      errorBox.textContent = "⚠ Error validating image.";
      errorBox.classList.remove('hidden');
      previewContainer.classList.add('hidden');
      profileInput.value = "";
    }
  });
</script>